!(function(){var e=window.twt.script.register
$.ajaxPrefilter(function(e,t,o){e.dataTypes=["json"]})
var t=function(e,t){return e=+e,isNaN(e)&&(e=t),e},o=function r(e,o){if(void 0===e||null===e)return Array.isArray(o)?[]:o
switch(typeof o){case"string":return""+e
case"number":return t(e,o)
case"boolean":return"false"!==e&&!!e
case"object":return null===o?e:Array.isArray(o)?(o=o.length>0?o[0]:null,Array.isArray(e)?e.map(function(e){return r(e,o)}):[r(e,o)]):i(e,o)}return o},i=function(e,t){if("object"!=typeof e)return o(e,t)
for(var i={},r=Object.keys(t),n=0;n<r.length;++n){var s=r[n]
i[s]=o(e[s],t[s])}return i}
e("footer/submit",function(e){var t,o=null,r=function(){o=setTimeout(function(){$("#dropzone").removeClass("in"),o=null},10)},n=function(e){return i(e,{id:0,name:"",groups:[{id:0,name:"",type:0}],notice:"",active:1,limit:0,require_desc:0,require_review:0,start_time:0,end_time:0})},s=new Vue({el:"#fileWindow",data:function(){return{selectVideo:0,selectCount:0,list:[],selectCover:!1,formError:"",form:{name:"",desc:"",cover:0,event:0,group:0},events:[],event:n({}),eventLoading:!1,progress:0,cover:null,show:!1,size:null}},computed:{groupSelect:function(){var e=this
return this.event.groups.filter(function(t){return t.type===(e.selectVideo?2:1)})},hasGroup:function(){return this.event.groups.length&&0!==this.groupSelect.length}},watch:{"form.event":function(e){return"0"===e?void(s.event=n({})):void(s.event=n(s.events[e]))}},methods:{coverSel:function(){s.selectCover?s.selectCover=!1:(s.selectCover=!0,s.cover&&(s.cover.selected&&(s.cover.selected=!1,--s.selectCount),s.form.cover=0,s.cover=null))},close:function(){a=!1,s.size={width:0,height:"20px"},s.show=!1,setTimeout(function(){$("#fileWindow").hide(),s.size=null},1e3)},submit:function(){if(s.formError="",!s.form.name||s.selectVideo&&!s.form.cover)return void(s.formError="请将必填项填写完整")
var o=[]
for(t=0;t<s.list.length;++t)!s.list[t].selected||s.selectVideo&&s.list[t].id===s.form.cover||o.push(s.list[t].id)
if(0===o.length)return s.formError="没有选择作品",void(s.selectCount=0)
var i={token:e,name:s.form.name,desc:s.form.desc,event:s.form.event,group:s.form.group,type:s.selectVideo?"video":"image",cover:s.form.cover}
for(t=0;t<o.length;t++)i.attach=o[t],$.post("/work",i,function(e){for(var t,o=0;o<s.list.length;++o)if(t=s.list[o],t.id===e.data.attach_id||t.id===e.data.cover_id){if(e.errno){if(400===e.errno){s.formError=e.errmsg
break}t.status="failed",t.error=e.errmsg}else t.status="done",t.workId=e.data.id
t.selected&&(--s.selectCount,t.selected=!1)
break}})},reset:function(){s.form={name:"",desc:"",cover:0,event:0,group:0}},select:function(e){if("ok"===e.status)if(e.selected)s.cover&&s.cover.id===e.id&&(s.cover=null,s.form.cover=0),--s.selectCount,e.selected=!1
else{if(e.isVideo){if(0!==s.selectCount)for(t=0;t<s.list.length;++t)s.list[t].selected=!1
s.selectVideo=1,s.selectCover=!1,s.selectCount=1,s.form.cover=0,s.cover=null}else if(s.selectCover)++s.selectCount,s.selectCover=!1,s.form.cover=e.id,s.cover=e
else{if(s.selectVideo&&0!==s.selectCount){for(t=0;t<s.list.length;++t)s.list[t].selected=!1
s.selectVideo=0}++s.selectCount}e.selected=!0}},remove:function(t){"ok"===t.status&&(t.selected&&this.select(t),$.post("/work/commit",{token:e,_method:"delete",id:t.id},function(e){if(e.errno)t.status="failed",t.error=e.errmsg,console.log(e)
else for(var o=0;o<s.list.length;++o)if(s.list[o].id===t.id){s.list.splice(o,1)
break}}))}}}),l=function(t,o){$.post("/work/commit",{file:t,token:e},function(e){if(e.errno)o.status="failed",o.error=e.errmsg,console.log(e)
else{o.id=e.data.id,o.status="ok",o.isVideo=e.data.is_video
var t=e.data.url
if(o.url=t,!o.isVideo){var i=t.lastIndexOf(".")
o.thumbUrl=t.substr(0,i)+"_thumb"+t.substr(i)}}})}
$(document).bind("dragover",function(e){for(var t=e.originalEvent.dataTransfer.items,i=!1,r=0;r<t.length;++r)if("file"===t[r].kind){i=!0
break}i&&(o&&(clearTimeout(o),o=null),$("#dropzone").addClass("in"))}),$(document).bind("dragleave",r),$(document).bind("drop",r),$("#fileupload").fileupload({url:"/work/upload",formData:{token:e},dropZone:$("#dropzone"),dataType:"json",acceptFileTypes:/\.(mp4|jpe?g)$/i,maxChunkSize:20971520,maxFileSize:104857600,maxRetries:100,retryTimeout:500,add:function(e,t){var o=this,i=t.files[0]
t.context={vm:{id:0,name:i.name,selected:!1,status:"upload",error:"",isVideo:0,url:"",workId:0}},s.list.push(t.context.vm),$.getJSON("/work/upload",{file:i.name},function(r){if(r.file){var n=r.file.size
if(+n===+i.size)return l(i.name,t.context.vm)
n>i.size&&(t.uploadedBytes=n)}$.blueimp.fileupload.prototype.options.add.call(o,e,t)})},done:function(e,t){var o=t.result.files[0]
o.error?(t.context.status="failed",t.context.error=o.error):l(o.name,t.context.vm)},fail:function(e,t){var o=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),i=t.context.retries||0,r=function(){$.getJSON("/work/upload",{file:t.files[0].name}).done(function(e){var o=e.file
t.uploadedBytes=o&&o.size,t.data=null,t.submit()}).fail(function(){o._trigger("fail",e,t)})}
return"abort"!==t.errorThrown&&t.uploadedBytes<t.files[0].size&&i<o.options.maxRetries?(t.context.retries=++i,window.setTimeout(r,i*o.options.retryTimeout)):(t.context.retries=null,void console.log(e,t))},progress:function(e,t){s.progress=t.loaded/t.total*100,100===s.progress&&setTimeout(function(){s.progress=0},400)}}),window.workChoose=function(){$("#fileupload").click()}
var a=!1,c=function(){if(a){var e=$(window).width(),t=!1
e>900?e=900:e>543?e-=40:(t=!0,e-=20),s.size={transitionDuration:s.size&&s.size.transitionDuration||"",transitionDelay:s.size&&s.size.transitionDelay||"",height:(t?$(window).height()-100:480)+"px",width:e+"px"}}}
$(window).on("resize",c)
var d=!1
window.workSubmit=function(){$("#fileWindow").show(),d||(d=!0,$.get("/event?active=1",function(e){s.events=e.data})),setTimeout(function(){s.show=!0,a=!0,c(),setTimeout(function(){s.size.transitionDelay="0s",s.size.transitionDuration="0s"},1010)},10)}}),e("index",function(){var e={Android:function(){return!!navigator.userAgent.match(/Android/i)},BlackBerry:function(){return!!navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return!!navigator.userAgent.match(/iPhone|iPad|iPod/i)},Windows:function(){return!!navigator.userAgent.match(/IEMobile/i)},common:function(){return!!navigator.userAgent.match(/Mobile/i)},any:function(){return e.Android()||e.BlackBerry()||e.iOS()||e.Windows()||e.common()},WeChat:function(){return!!navigator.userAgent.match(/MicroMessenger/i)}},t=e.any()
if(e.WeChat()){var o=$("#wechatLogin")
o.length&&o.text("微信登录")}var i,r=$(".tp-bg"),n=r.children(),s=n.length,l=null,a=!1,c={},d=function(){var e=$(window).width(),t=$(window).height()
$("#main-wrap").css({paddingTop:e>543?Math.max(0,Math.floor((t-$("#main-wrap").height())/2-2*$(".twt-header-height").height())):0}),a&&u()},u=function(e){var t=$(window).width(),o=$(window).height(),r={},n=c.w/c.h
t/o>n?(r.width=t,r.left=0,r.height=t/n,r.top=(o-r.height)/2):(r.height=o,r.top=0,r.width=o*n,r.left=(t-r.width)/2),i.css(r)},f=function(){null!==l?(n.eq(l).removeClass("in"),++l,l>=s&&(l=0)):l=0
var e=n.eq(l)
e.addClass("in"),a="video"===e.attr("mode"),a?(t&&f(),i=e.find("video"),c={w:i[0].videoWidth,h:i[0].videoHeight},u(),i[0].play(),i.one("ended",f)):setTimeout(f,1e4)}
$(window).on("resize",d),d(),t||n.each(function(e,t){t.style.display=""}),r.show(),setTimeout(f,500)}),e("list/index",function(e){$("#gallery").justifiedGallery({margins:5,rowHeight:240}),$("#gallery").css({visibility:"visible"})
var t=$("#load-btn"),o=$("#load-img"),i=$("#load-msg"),r=!1,n=function(){r||(r=!0,t.hide(),o.show(),i.hide(),$.get(window.location.pathname,{from:e},function(n){if(o.hide(),n.errno)i.show(),i.text(n.errmsg)
else{if(!n.data.length)return i.show(),void i.text("已经到底啦！")
for(var s,l=0;l<n.data.length;l++)s=n.data[l],$("#gallery").append($("<a>",{href:"/work/"+s.id,html:[$("<div>",{"class":"tp-gallery-info",html:[$("<h4>",{text:s.name}),$("<p>",{text:"By: "+s.author_name})]}),$("<img>",{src:"/upload/"+s.cover})]}))
e=s.id,$("#gallery").justifiedGallery("norewind")}r=!1,t.show(),o.hide()}))}
$(window).scroll(function(){$(window).scrollTop()+$(window).height()===$(document).height()&&n()}),t.click(n)}),e("work",function(e,t){var o=!1
$("#deleteBtn").click(function(){!o&&window.confirm("你确定要删除此作品吗？")&&(o=!0,$.post("/work/"+e,{token:t,_method:"delete"},function(t){t.errno?window.alert(t.errmsg):window.location.href="/work/"+e}))})
var i=function(i){o||(o=!0,$.post("/work/"+e,{token:t,accept:i?"yes":"no"},function(t){t.errno?window.alert(t.errmsg):window.location.href="/work/"+e}))}
$("#acceptBtn").click(function(){i(!0)}),$("#rejectBtn").click(function(){i(!1)})})}())
